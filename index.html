<!-- 针对生产环境的功能扩展实现方案 -->

<!-- 一、产品数据库对接 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "zipperpro-cn.firebaseapp.com",
  databaseURL: "https://zipperpro-cn-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "zipperpro-cn",
  storageBucket: "zipperpro-cn.appspot.com",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

async function loadProducts() {
  const productsRef = ref(db, 'products');
  const snapshot = await get(productsRef);
  const products = snapshot.val();
  const container = document.getElementById('productsContainer');
  container.innerHTML = Object.values(products).map(product => `
    <div class="col-md-4 mb-4">
      <div class="product-card h-100">
        <img src="${product.images[0]}" class="product-img w-100" alt="${product.name}" loading="lazy">
        <div class="p-3">
          <h5>${product.name}</h5>
          <p class="text-muted small">${product.description}</p>
          <div class="d-flex justify-content-between">
            <span class="text-success fw-bold">\u00a5${product.basePrice}</span>
            <button class="btn btn-sm btn-primary" onclick="showInquiryModal('${product.id}')">立即询价</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

window.addEventListener('DOMContentLoaded', loadProducts);
</script>

<!-- 二、在线询价表单 -->
<div class="modal fade" id="inquiryModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">定制需求提交</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="inquiryForm" onsubmit="handleSubmit(event)">
        <div class="modal-body">
          <input type="hidden" id="productId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">联系人姓名</label>
              <input type="text" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">联系电话</label>
              <input type="tel" class="form-control" pattern="[0-9]{11}" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">预估数量（条）</label>
              <input type="number" class="form-control" min="1000" value="5000" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">期望交货日期</label>
              <input type="date" class="form-control" min="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="col-md-12">
              <label class="form-label">特殊要求说明</label>
              <textarea class="form-control" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100">提交需求</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
async function handleSubmit(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const payload = Object.fromEntries(formData);
  try {
    const response = await fetch('/api/inquiry', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(response.ok) {
      alert('需求已提交，客服将在1小时内联系您');
      bootstrap.Modal.getInstance('#inquiryModal').hide();
    }
  } catch(error) {
    console.error('提交失败:', error);
  }
}
</script>

<!-- 三、智能推荐算法 -->
<script>
const recommendationEngine = {
  viewedProducts: [],
  trackView(productId) {
    this.viewedProducts = [...new Set([productId, ...this.viewedProducts])];
    localStorage.setItem('viewHistory', JSON.stringify(this.viewedProducts));
  },
  async getRecommendations() {
    const history = JSON.parse(localStorage.getItem('viewHistory') || '[]');
    const snapshot = await get(ref(db, 'products'));
    const allProducts = Object.values(snapshot.val());
    return allProducts.filter(product => {
      return !history.includes(product.id) && 
        product.tags.some(tag => this.viewedProducts.some(vp => vp.tags.includes(tag)));
    }).slice(0, 4);
  },
  renderRecommendations() {
    this.getRecommendations().then(products => {
      const container = document.getElementById('recommendations');
      container.innerHTML = products.map(prod => `
        <div class="col-3">
          <a href="/product/${prod.id}" class="recommend-card">
            <img src="${prod.thumbnail}" alt="${prod.name}">
            <h6>${prod.name}</h6>
          </a>
        </div>
      `).join('');
    });
  }
};
</script>

